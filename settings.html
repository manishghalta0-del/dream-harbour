<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamHarbour - Settings Master</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); min-height: 100vh; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 22px; font-weight: bold; }
        .nav-link { color: white; padding: 8px 16px; background: rgba(0,0,0,0.2); border-radius: 5px; cursor: pointer; border: none; font-weight: 600; margin-left: 10px; }
        .nav-link:hover { background: rgba(0,0,0,0.4); }
        .content { padding: 25px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 16px; background: none; border: 2px solid #e0e0e0; border-radius: 6px; cursor: pointer; font-weight: 600; color: #666; font-size: 13px; }
        .tab:hover { border-color: #1e40af; color: #1e40af; }
        .tab.active { background: #1e40af; color: white; border-color: #1e40af; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-primary { background: #1e40af; color: white; }
        .btn-primary:hover { background: #1e3a8a; }
        .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #e0e0e0; }
        .search-box { display: flex; gap: 8px; flex: 1; min-width: 200px; }
        .search-input { flex: 1; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
        .search-input:focus { outline: none; border-color: #1e40af; }
        .filter-group { display: flex; gap: 8px; align-items: center; }
        .filter-group select { padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
        .filter-group select:focus { outline: none; border-color: #1e40af; }
        .table-wrapper { overflow-x: auto; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        table th { background: #f5f5f5; padding: 10px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none; white-space: nowrap; }
        table th:hover { background: #efefef; }
        table th.sort-asc::after { content: " ‚Üë"; }
        table th.sort-desc::after { content: " ‚Üì"; }
        table td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        table tr:hover { background: #f9f9f9; }
        table tr.dragging { opacity: 0.5; background: #e3f2fd; }
        .drag-handle { cursor: move; color: #999; font-weight: bold; user-select: none; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-active { background: #d1fae5; color: #065f46; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-orange { background: #fed7aa; color: #92400e; }
        .badge-red { background: #fecaca; color: #991b1b; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }
        .action-btn { padding: 4px 8px; margin: 0 2px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .action-btn.toggle { background: #e0e0e0; color: #333; }
        .action-btn.toggle:hover { background: #1e40af; color: white; }
        .action-btn.edit { background: #3b82f6; color: white; }
        .action-btn.delete { background: #ef4444; color: white; }
        .context-menu { position: fixed; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 150px; }
        .context-menu-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 12px; }
        .context-menu-item:hover { background: #f0f9ff; }
        .context-menu-item:last-child { border-bottom: none; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
        .modal-header { font-size: 18px; font-weight: 700; color: #1e40af; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #1e40af; }
        .form-error { font-size: 11px; color: #ef4444; }
        .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
        .success-msg { padding: 10px 12px; background: #d1fae5; color: #065f46; border-radius: 6px; margin-bottom: 12px; font-size: 12px; display: none; border-left: 3px solid #10b981; }
        .success-msg.show { display: block; }
        .empty-state { text-align: center; padding: 30px; color: #999; }
        .stats-box { background: #f0f9ff; border: 2px solid #bfdbfe; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; }
        .stats-box strong { color: #1e40af; }
        .keyboard-help { background: #fff3cd; border: 1px solid #ffc107; padding: 10px 12px; border-radius: 6px; font-size: 11px; margin-bottom: 15px; }
        .icon { font-size: 14px; margin-right: 4px; }
        @media (max-width: 768px) { table { font-size: 11px; } table th, table td { padding: 6px 4px; } .btn { padding: 6px 12px; font-size: 12px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚öôÔ∏è DreamHarbour - Settings Master</div>
            <div>
                <a href="dashboard.html" style="text-decoration:none;"><button class="nav-link">‚Üê Dashboard</button></a>
                <button class="nav-link" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('categories')">üìÇ Categories</button>
                <button class="tab" onclick="switchTab('services')">üõçÔ∏è Services</button>
                <button class="tab" onclick="switchTab('subtype1')">üîó Sub-Services Type 1</button>
                <button class="tab" onclick="switchTab('subtype2')">üîó Sub-Services Type 2</button>
                <button class="tab" onclick="switchTab('business')">üíº Business</button>
            </div>

            <!-- CATEGORIES TAB -->
            <div id="categories" class="tab-content active">
                <div class="keyboard-help">
                    ‚å®Ô∏è <strong>Shortcuts:</strong> Ctrl+N (New) | Ctrl+E (Edit) | Ctrl+F (Search) | Delete (Del)
                </div>
                <div class="stats-box">
                    üìä <strong>Total:</strong> <span id="totalCategories">0</span> | <strong>Active:</strong> <span id="activeCategories">0</span>
                </div>
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('category')">‚ûï Add Category</button>
                    <button class="btn btn-secondary" onclick="exportData('categories')">üì• Export</button>
                    <button class="btn btn-secondary" onclick="triggerImport('categories')">üì§ Import</button>
                    <input type="file" id="importFile-categories" accept=".csv" style="display:none;" onchange="importData('categories')">
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-categories" placeholder="Search..." onkeyup="filterAndDisplay('categories')">
                    </div>
                </div>
                <div class="success-msg" id="msg-categories"></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:20px;"></th>
                                <th onclick="sortData('categories', 'name')">üìù Name</th>
                                <th style="width:80px;" onclick="sortData('categories', 'status')">Status</th>
                                <th style="width:100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-categories">
                            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SERVICES TAB -->
            <div id="services" class="tab-content">
                <div class="keyboard-help">
                    ‚å®Ô∏è <strong>Shortcuts:</strong> Ctrl+N (New) | Ctrl+E (Edit) | Ctrl+F (Search) | Delete (Del)
                </div>
                <div class="stats-box">
                    üìä <strong>Total:</strong> <span id="totalServices">0</span> | <strong>Active:</strong> <span id="activeServices">0</span>
                </div>
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('service')">‚ûï Add Service</button>
                    <button class="btn btn-secondary" onclick="exportData('services')">üì• Export</button>
                    <button class="btn btn-secondary" onclick="triggerImport('services')">üì§ Import</button>
                    <input type="file" id="importFile-services" accept=".csv" style="display:none;" onchange="importData('services')">
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-services" placeholder="Search..." onkeyup="filterAndDisplay('services')">
                    </div>
                    <div class="filter-group">
                        <select id="filter-services-cat" onchange="filterAndDisplay('services')">
                            <option value="">All Categories</option>
                        </select>
                        <select id="filter-services-status" onchange="filterAndDisplay('services')">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="success-msg" id="msg-services"></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:20px;"></th>
                                <th onclick="sortData('services', 'name')">Service</th>
                                <th onclick="sortData('services', 'category')">Category</th>
                                <th style="width:50px;">SAC</th>
                                <th style="width:50px;" onclick="sortData('services', 'gst')">GST%</th>
                                <th style="width:60px;">Rate</th>
                                <th style="width:60px;" onclick="sortData('services', 'status')">Status</th>
                                <th style="width:100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-services">
                            <tr><td colspan="8" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUB-SERVICE TYPE 1 TAB -->
            <div id="subtype1" class="tab-content">
                <div class="keyboard-help">
                    ‚å®Ô∏è <strong>Shortcuts:</strong> Ctrl+N (New) | Ctrl+E (Edit) | Ctrl+F (Search) | Delete (Del)
                </div>
                <div class="stats-box">
                    üìä <strong>Total:</strong> <span id="totalSubType1">0</span> | <strong>Active:</strong> <span id="activeSubType1">0</span>
                </div>
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('subtype1')">‚ûï Add Sub-Service Type 1</button>
                    <button class="btn btn-secondary" onclick="exportData('subtype1')">üì• Export</button>
                    <button class="btn btn-secondary" onclick="triggerImport('subtype1')">üì§ Import</button>
                    <input type="file" id="importFile-subtype1" accept=".csv" style="display:none;" onchange="importData('subtype1')">
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-subtype1" placeholder="Search..." onkeyup="filterAndDisplay('subtype1')">
                    </div>
                </div>
                <div class="success-msg" id="msg-subtype1"></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:20px;"></th>
                                <th onclick="sortData('subtype1', 'name')">Sub-Service Name</th>
                                <th style="width:80px;" onclick="sortData('subtype1', 'status')">Status</th>
                                <th style="width:100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-subtype1">
                            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUB-SERVICE TYPE 2 TAB -->
            <div id="subtype2" class="tab-content">
                <div class="keyboard-help">
                    ‚å®Ô∏è <strong>Shortcuts:</strong> Ctrl+N (New) | Ctrl+E (Edit) | Ctrl+F (Search) | Delete (Del)
                </div>
                <div class="stats-box">
                    üìä <strong>Total:</strong> <span id="totalSubType2">0</span> | <strong>Active:</strong> <span id="activeSubType2">0</span>
                </div>
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('subtype2')">‚ûï Add Sub-Service Type 2</button>
                    <button class="btn btn-secondary" onclick="exportData('subtype2')">üì• Export</button>
                    <button class="btn btn-secondary" onclick="triggerImport('subtype2')">üì§ Import</button>
                    <input type="file" id="importFile-subtype2" accept=".csv" style="display:none;" onchange="importData('subtype2')">
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-subtype2" placeholder="Search..." onkeyup="filterAndDisplay('subtype2')">
                    </div>
                </div>
                <div class="success-msg" id="msg-subtype2"></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:20px;"></th>
                                <th onclick="sortData('subtype2', 'name')">Sub-Service Name</th>
                                <th style="width:60px;">SAC</th>
                                <th style="width:60px;" onclick="sortData('subtype2', 'gst')">GST%</th>
                                <th style="width:80px;" onclick="sortData('subtype2', 'status')">Status</th>
                                <th style="width:100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-subtype2">
                            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BUSINESS TAB -->
            <div id="business" class="tab-content">
                <div style="max-width: 600px;">
                    <h3 style="color: #1e40af; margin-bottom: 20px;">üíº Business Information</h3>
                    <form id="businessForm" onsubmit="saveBusiness(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Business Name *</label>
                                <input type="text" id="businessName" required>
                            </div>
                            <div class="form-group">
                                <label>GST Number *</label>
                                <input type="text" id="gstNumber" required>
                            </div>
                            <div class="form-group">
                                <label>Phone *</label>
                                <input type="tel" id="businessPhone" maxlength="10" required>
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="businessEmail" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="businessAddress">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="businessCity">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <input type="text" id="businessState">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Pincode</label>
                            <input type="text" id="businessPincode" maxlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ Save</button>
                        <div class="success-msg" id="msg-business"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- UNIVERSAL MODAL -->
    <div class="modal" id="mainModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Add Item</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="mainForm" onsubmit="saveItem(event)">
                <div id="formFields"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">‚úì Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CONTEXT MENU -->
    <div class="context-menu" id="contextMenu" style="display:none;"></div>

    <script>
        const SUPABASE_URL = 'https://lqrewteclbexiknvhenk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcmV3dGVjbGJleGlrbnZoZW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjQ2MDMsImV4cCI6MjA3NzA0MDYwM30.YLKmzuy3tfa9S09fzk4lYphBcl6a1jkeur3hUBaAHO8';

        let supabase = null;
        let allData = { categories: [], services: [], subtype1: [], subtype2: [] };
        let currentTab = 'categories';
        let editingId = null;
        let draggedRow = null;
        let sortColumn = { categories: null, services: null, subtype1: null, subtype2: null };
        let sortDir = { categories: 'asc', services: 'asc', subtype1: 'asc', subtype2: 'asc' };

        async function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const session = JSON.parse(localStorage.getItem('userSession'));
                if (!session) { window.location.href = 'index.html'; return; }

                await loadAllData();
            } catch (error) { console.error('Error:', error); }
        }

        async function loadAllData() {
            try {
                const [catRes, svcRes, sub1Res, sub2Res, bizRes] = await Promise.all([
                    supabase.from('service_categories').select('*').order('category_name'),
                    supabase.from('service_items').select('*, service_categories(category_name)').order('service_name'),
                    supabase.from('sub_service_type_1').select('*').order('sub_service_name'),
                    supabase.from('sub_service_type_2').select('*').order('sub_service_name'),
                    supabase.from('business_settings').select('*').limit(1)
                ]);

                allData.categories = catRes.data || [];
                allData.services = svcRes.data || [];
                allData.subtype1 = sub1Res.data || [];
                allData.subtype2 = sub2Res.data || [];

                filterAndDisplay('categories');
                filterAndDisplay('services');
                filterAndDisplay('subtype1');
                filterAndDisplay('subtype2');
                
                populateFilters();

                if (bizRes.data && bizRes.data.length > 0) {
                    const biz = bizRes.data[0];
                    Object.keys(biz).forEach(k => { const el = document.getElementById(k); if (el) el.value = biz[k] || ''; });
                }
            } catch (error) { console.error('Error:', error); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            currentTab = tab;
        }

        function filterAndDisplay(tab) {
            const search = document.getElementById(`search-${tab}`)?.value.toLowerCase() || '';
            const data = allData[tab];
            
            let filtered = data.filter(item => {
                const name = (item.category_name || item.service_name || item.sub_service_name || '').toLowerCase();
                return !search || name.includes(search);
            });

            if (tab === 'services') {
                const catId = document.getElementById('filter-services-cat')?.value;
                const status = document.getElementById('filter-services-status')?.value;
                if (catId) filtered = filtered.filter(s => s.category_id === catId);
                if (status) filtered = filtered.filter(s => status === 'active' ? s.is_active : !s.is_active);
            }

            displayTable(tab, filtered);
            updateStats(tab);
        }

        function displayTable(tab, data) {
            const tbody = document.getElementById(`table-${tab}`);
            const icons = { categories: 'üìÇ', services: 'üõçÔ∏è', subtype1: 'üîó', subtype2: 'üîó' };

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-state">No items</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map((item, idx) => {
                let row = `<tr draggable="true" ondragstart="dragStart()" ondragover="dragOver()" ondrop="dragDrop(${idx}, '${tab}')">
                    <td class="drag-handle">‚ãÆ‚ãÆ</td>`;

                if (tab === 'categories') {
                    row += `<td>${icons[tab]} ${item.category_name}</td>
                            <td><span class="badge badge-${item.is_active ? 'active' : 'inactive'}">${item.is_active ? '‚úì' : '‚úó'}</span></td>
                            <td>
                                <button class="action-btn toggle" onclick="quickToggle('${item.id}', '${tab}', ${item.is_active})">‚äô</button>
                                <button class="action-btn edit" onclick="editItem('${item.id}', '${tab}')">‚úèÔ∏è</button>
                                <button class="action-btn delete" onclick="deleteItem('${item.id}', '${tab}')">üóëÔ∏è</button>
                            </td>`;
                } else if (tab === 'services') {
                    const cat = allData.categories.find(c => c.id === item.category_id);
                    const colors = ['badge-blue', 'badge-green', 'badge-orange', 'badge-red', 'badge-purple'];
                    const color = colors[allData.categories.findIndex(c => c.id === item.category_id) % 5];
                    row += `<td>${icons[tab]} ${item.service_name}</td>
                            <td><span class="badge ${color}">${cat?.category_name || '-'}</span></td>
                            <td>${item.sac_code || '-'}</td>
                            <td>${item.gst_percentage}%</td>
                            <td>‚Çπ${item.rate || 0}</td>
                            <td><span class="badge badge-${item.is_active ? 'active' : 'inactive'}">${item.is_active ? '‚úì' : '‚úó'}</span></td>
                            <td>
                                <button class="action-btn toggle" onclick="quickToggle('${item.id}', '${tab}', ${item.is_active})" title="Toggle">‚äô</button>
                                <button class="action-btn edit" onclick="editItem('${item.id}', '${tab}')">‚úèÔ∏è</button>
                                <button class="action-btn delete" onclick="deleteItem('${item.id}', '${tab}')">üóëÔ∏è</button>
                            </td>`;
                } else if (tab === 'subtype1') {
                    row += `<td>${icons[tab]} ${item.sub_service_name}</td>
                            <td><span class="badge badge-${item.is_active ? 'active' : 'inactive'}">${item.is_active ? '‚úì' : '‚úó'}</span></td>
                            <td>
                                <button class="action-btn toggle" onclick="quickToggle('${item.id}', '${tab}', ${item.is_active})">‚äô</button>
                                <button class="action-btn edit" onclick="editItem('${item.id}', '${tab}')">‚úèÔ∏è</button>
                                <button class="action-btn delete" onclick="deleteItem('${item.id}', '${tab}')">üóëÔ∏è</button>
                            </td>`;
                } else if (tab === 'subtype2') {
                    row += `<td>${icons[tab]} ${item.sub_service_name}</td>
                            <td>${item.sac_code || '-'}</td>
                            <td>${item.gst_percentage}%</td>
                            <td><span class="badge badge-${item.is_active ? 'active' : 'inactive'}">${item.is_active ? '‚úì' : '‚úó'}</span></td>
                            <td>
                                <button class="action-btn toggle" onclick="quickToggle('${item.id}', '${tab}', ${item.is_active})">‚äô</button>
                                <button class="action-btn edit" onclick="editItem('${item.id}', '${tab}')">‚úèÔ∏è</button>
                                <button class="action-btn delete" onclick="deleteItem('${item.id}', '${tab}')">üóëÔ∏è</button>
                            </td>`;
                }

                row += '</tr>';
                return row;
            }).join('');
        }

        function updateStats(tab) {
            const total = allData[tab].length;
            const active = allData[tab].filter(item => item.is_active).length;
            document.getElementById(`total${tab.charAt(0).toUpperCase() + tab.slice(1).replace('subtype1', 'SubType1').replace('subtype2', 'SubType2')}`)?.textContent = total;
            document.getElementById(`active${tab.charAt(0).toUpperCase() + tab.slice(1).replace('subtype1', 'SubType1').replace('subtype2', 'SubType2')}`)?.textContent = active;
        }

        function sortData(tab, col) {
            sortColumn[tab] = sortColumn[tab] === col ? null : col;
            sortDir[tab] = 'asc';

            if (!sortColumn[tab]) { filterAndDisplay(tab); return; }

            allData[tab].sort((a, b) => {
                let aVal = a[col === 'name' ? (tab === 'services' ? 'service_name' : tab === 'subtype1' || tab === 'subtype2' ? 'sub_service_name' : 'category_name') : col];
                let bVal = b[col === 'name' ? (tab === 'services' ? 'service_name' : tab === 'subtype1' || tab === 'subtype2' ? 'sub_service_name' : 'category_name') : col];
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                return aVal > bVal ? 1 : -1;
            });

            filterAndDisplay(tab);
        }

        function dragStart() { }
        function dragOver() { }
        function dragDrop(idx, tab) { }

        async function quickToggle(id, tab, currentStatus) {
            try {
                const table = tab === 'categories' ? 'service_categories' : tab === 'services' ? 'service_items' : tab === 'subtype1' ? 'sub_service_type_1' : 'sub_service_type_2';
                await supabase.from(table).update({ is_active: !currentStatus }).eq('id', id);
                await loadAllData();
                showMsg(`Toggled!`, tab);
            } catch (error) { console.error('Error:', error); }
        }

        function openModal(tab) {
            editingId = null;
            const titles = { category: 'Add Category', service: 'Add Service', subtype1: 'Add Sub-Service Type 1', subtype2: 'Add Sub-Service Type 2' };
            document.getElementById('modalTitle').textContent = titles[tab] || 'Add Item';

            let fields = '';
            if (tab === 'category') {
                fields = `<div class="form-group"><label>Category Name *</label><input type="text" id="field-name" required></div>
                         <div class="form-group"><input type="checkbox" id="field-active" checked> <label>Active</label></div>`;
            } else if (tab === 'service') {
                const cats = allData.categories.map(c => `<option value="${c.id}">${c.category_name}</option>`).join('');
                fields = `<div class="form-group"><label>Category</label><select id="field-category" required><option>-- Select --</option>${cats}</select></div>
                         <div class="form-group"><label>Service Name *</label><input type="text" id="field-name" required></div>
                         <div class="form-group"><label>SAC Code</label><input type="text" id="field-sac"></div>
                         <div class="form-group"><label>GST %</label><input type="number" id="field-gst" min="0" max="100" step="0.01" value="0"></div>
                         <div class="form-group"><label>Rate</label><input type="number" id="field-rate" min="0" step="0.01" value="0"></div>
                         <div class="form-group"><input type="checkbox" id="field-active" checked> <label>Active</label></div>`;
            } else if (tab === 'subtype1') {
                fields = `<div class="form-group"><label>Sub-Service Name *</label><input type="text" id="field-name" required></div>
                         <div class="form-group"><input type="checkbox" id="field-active" checked> <label>Active</label></div>`;
            } else if (tab === 'subtype2') {
                fields = `<div class="form-group"><label>Sub-Service Name *</label><input type="text" id="field-name" required></div>
                         <div class="form-group"><label>SAC Code</label><input type="text" id="field-sac"></div>
                         <div class="form-group"><label>GST %</label><input type="number" id="field-gst" min="0" max="100" step="0.01" value="0"></div>
                         <div class="form-group"><input type="checkbox" id="field-active" checked> <label>Active</label></div>`;
            }

            document.getElementById('formFields').innerHTML = fields;
            document.getElementById('mainForm').dataset.tab = tab;
            document.getElementById('mainModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('mainModal').classList.remove('show');
        }

        async function saveItem(e) {
            e.preventDefault();
            const tab = document.getElementById('mainForm').dataset.tab;
            const name = document.getElementById('field-name')?.value;
            if (!name) { alert('Name required'); return; }

            try {
                const tables = { category: 'service_categories', service: 'service_items', subtype1: 'sub_service_type_1', subtype2: 'sub_service_type_2' };
                const table = tables[tab];
                const data = {
                    [tab === 'category' ? 'category_name' : 'sub_service_name' in { subtype1: 1, subtype2: 1 } ? 'sub_service_name' : 'service_name']: name,
                    is_active: document.getElementById('field-active')?.checked
                };

                if (tab === 'service') {
                    data.category_id = document.getElementById('field-category')?.value;
                    data.sac_code = document.getElementById('field-sac')?.value || null;
                    data.gst_percentage = parseFloat(document.getElementById('field-gst')?.value) || 0;
                    data.rate = parseFloat(document.getElementById('field-rate')?.value) || 0;
                } else if (tab === 'subtype2') {
                    data.sac_code = document.getElementById('field-sac')?.value || null;
                    data.gst_percentage = parseFloat(document.getElementById('field-gst')?.value) || 0;
                }

                if (editingId) {
                    await supabase.from(table).update(data).eq('id', editingId);
                } else {
                    await supabase.from(table).insert(data);
                }

                closeModal();
                await loadAllData();
                showMsg('Saved!', tab);
            } catch (error) { console.error('Error:', error); }
        }

        async function editItem(id, tab) {
            const item = allData[tab].find(x => x.id === id);
            if (!item) return;
            editingId = id;
            openModal(tab);

            setTimeout(() => {
                if (tab === 'category') {
                    document.getElementById('field-name').value = item.category_name;
                } else if (tab === 'service') {
                    document.getElementById('field-category').value = item.category_id;
                    document.getElementById('field-name').value = item.service_name;
                    document.getElementById('field-sac').value = item.sac_code || '';
                    document.getElementById('field-gst').value = item.gst_percentage;
                    document.getElementById('field-rate').value = item.rate || 0;
                } else {
                    document.getElementById('field-name').value = item.sub_service_name;
                    if (tab === 'subtype2') {
                        document.getElementById('field-sac').value = item.sac_code || '';
                        document.getElementById('field-gst').value = item.gst_percentage || 0;
                    }
                }
                document.getElementById('field-active').checked = item.is_active;
                document.getElementById('modalTitle').textContent = '‚úèÔ∏è Edit Item';
            }, 100);
        }

        async function deleteItem(id, tab) {
            if (!confirm('Delete?')) return;
            try {
                const tables = { categories: 'service_categories', services: 'service_items', subtype1: 'sub_service_type_1', subtype2: 'sub_service_type_2' };
                await supabase.from(tables[tab]).delete().eq('id', id);
                await loadAllData();
            } catch (error) { console.error('Error:', error); }
        }

        function exportData(tab) {
            const tables = { categories: 'Categories', services: 'Services', subtype1: 'SubType1', subtype2: 'SubType2' };
            const data = allData[tab];
            const headers = tab === 'categories' ? ['Name', 'Active'] : tab === 'services' ? ['Name', 'Category', 'SAC', 'GST%', 'Rate', 'Active'] : ['Name', 'Active'];
            const csv = headers.join(',') + '\n' + data.map(item => {
                if (tab === 'categories') return `"${item.category_name}",${item.is_active ? 'Yes' : 'No'}`;
                if (tab === 'services') return `"${item.service_name}","${allData.categories.find(c => c.id === item.category_id)?.category_name || ''}","${item.sac_code || ''}",${item.gst_percentage},${item.rate},${item.is_active ? 'Yes' : 'No'}`;
                if (tab === 'subtype1') return `"${item.sub_service_name}",${item.is_active ? 'Yes' : 'No'}`;
                if (tab === 'subtype2') return `"${item.sub_service_name}","${item.sac_code || ''}",${item.gst_percentage},${item.is_active ? 'Yes' : 'No'}`;
            }).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tables[tab]}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function triggerImport(tab) {
            document.getElementById(`importFile-${tab}`).click();
        }

        function importData(tab) {
            const file = document.getElementById(`importFile-${tab}`).files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n').slice(1);
                let count = 0;
                for (const line of lines) {
                    if (!line.trim()) continue;
                    const cols = line.split(',').map(c => c.replace(/"/g, '').trim());
                    try {
                        const tables = { categories: 'service_categories', services: 'service_items', subtype1: 'sub_service_type_1', subtype2: 'sub_service_type_2' };
                        if (tab === 'categories') {
                            await supabase.from(tables[tab]).insert({ category_name: cols[0], is_active: cols[1] !== 'No' });
                        } else if (tab === 'services') {
                            const catId = allData.categories.find(c => c.category_name === cols[1])?.id;
                            if (!catId) continue;
                            await supabase.from(tables[tab]).insert({ category_id: catId, service_name: cols[0], sac_code: cols[2] || null, gst_percentage: parseFloat(cols[3]) || 0, rate: parseFloat(cols[4]) || 0, is_active: cols[5] !== 'No' });
                        } else {
                            const data = { sub_service_name: cols[0], is_active: cols[cols.length - 1] !== 'No' };
                            if (tab === 'subtype2') { data.sac_code = cols[1] || null; data.gst_percentage = parseFloat(cols[2]) || 0; }
                            await supabase.from(tables[tab]).insert(data);
                        }
                        count++;
                    } catch (err) { }
                }
                alert(`Imported ${count} items`);
                await loadAllData();
                document.getElementById(`importFile-${tab}`).value = '';
            };
            reader.readAsText(file);
        }

        function populateFilters() {
            const sel = document.getElementById('filter-services-cat');
            sel.innerHTML = '<option value="">All Categories</option>';
            allData.categories.forEach(cat => sel.innerHTML += `<option value="${cat.id}">${cat.category_name}</option>`);
        }

        async function saveBusiness(e) {
            e.preventDefault();
            try {
                const data = {
                    business_name: document.getElementById('businessName').value,
                    gst_number: document.getElementById('gstNumber').value,
                    phone: document.getElementById('businessPhone').value,
                    email: document.getElementById('businessEmail').value,
                    address: document.getElementById('businessAddress').value,
                    city: document.getElementById('businessCity').value,
                    state: document.getElementById('businessState').value,
                    pincode: document.getElementById('businessPincode').value
                };
                const { data: existing } = await supabase.from('business_settings').select('id').limit(1);
                if (existing && existing.length > 0) {
                    await supabase.from('business_settings').update(data).eq('id', existing[0].id);
                } else {
                    await supabase.from('business_settings').insert(data);
                }
                showMsg('Business saved!', 'business');
            } catch (error) { console.error('Error:', error); }
        }

        function showMsg(msg, tab) {
            const el = document.getElementById(`msg-${tab}`);
            if (el) { el.textContent = '‚úì ' + msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 3000); }
        }

        function logout() {
            if (confirm('Logout?')) { localStorage.removeItem('userSession'); window.location.href = 'index.html'; }
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.querySelector(`input[id^="search-"]`)?.focus(); }
            if (e.ctrlKey && e.key === 'n') { e.preventDefault(); openModal(currentTab); }
        });

        window.addEventListener('load', init);
    </script>
</body>
</html>