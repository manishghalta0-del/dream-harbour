<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Harbour - Professional Billing System</title>
    <!-- Add all your meta and style blocks here (kept as per your design) -->
    <style>
    /* ... your CSS copied from your paste file ... */
    </style>
</head>
<body>
    <main id="main-form">
        <div class="container">
            <!-- ...Hero section as before... -->
            <!-- Login Form Section -->
            <div class="form-section">
                <!-- ...Header... -->
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1Indicator">
                        <div class="step-number">1</div>
                        <span>Phone</span>
                    </div>
                    <div class="step" id="step2Indicator">
                        <div class="step-number">2</div>
                        <span>PIN</span>
                    </div>
                </div>
                <!-- Step 1: Phone Number -->
                <form id="step1Form" class="step-1-form" onsubmit="nextStep(event)" novalidate>
                    <div class="form-group">
                        <label for="phoneNumber">Mobile Number <span style="color: #ef4444;">*</span></label>
                        <input type="tel" id="phoneNumber" maxlength="10" pattern="[0-9]{10}" required oninput="validatePhone()">
                        <div class="validation-feedback" id="phoneValidation"></div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Remember me</label>
                    </div>
                    <button type="submit" class="btn-login">Next</button>
                    <div class="error-message" id="step1Error"></div>
                </form>
                <!-- Step 2: PIN -->
                <form id="step2Form" class="step-2-form" onsubmit="handleLogin(event)" novalidate>
                    <div class="form-group">
                        <label for="pin">Security PIN <span style="color: #ef4444;">*</span></label>
                        <input type="password" id="pin" maxlength="6" pattern="[0-9]{6}" required oninput="validatePin()">
                        <div class="validation-feedback" id="pinValidation"></div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn-login" style="background: #888;" onclick="backStep()">Back</button>
                        <button type="submit" class="btn-login">Sign In</button>
                    </div>
                    <div class="forgot-pin-link" onclick="showForgotPinModal()">Forgot PIN?</div>
                    <div class="error-message" id="step2Error"></div>
                    <div class="success-message" id="successMessage"></div>
                </form>
            </div>
        </div>
    </main>
    <!-- Put modal, security badge, etc., here, as your original code -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://lqrewteclbexiknvhenk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcmV3dGVjbGJleGlrbnZoZW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjQ2MDMsImV4cCI6MjA3NzA0MDYwM30.YLKmzuy3tfa9S09fzk4lYphBcl6a1jkeur3hUBaAHO8';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function handleLogin(event) {
            event.preventDefault();

            const phone = document.getElementById('phoneNumber').value;
            const pin = document.getElementById('pin').value;
            const errorDiv = document.getElementById('step2Error');
            const successDiv = document.getElementById('successMessage');
            const button = event.target.querySelector('button[type="submit"]');

            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            if (!pin) {
                errorDiv.classList.add('show');
                errorDiv.innerHTML = `❌ PIN is required (E004)<br><span class="error-code">Error Code: E004</span>`;
                return;
            }

            if (pin.length !== 6 || !/^[0-9]{6}$/.test(pin)) {
                errorDiv.classList.add('show');
                errorDiv.innerHTML = `❌ PIN must be exactly 6 digits (E005)<br><span class="error-code">Error Code: E005</span>`;
                return;
            }

            button.disabled = true;
            button.classList.add('loading');
            button.setAttribute('aria-busy', 'true');
            button.textContent = 'Signing in...';

            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone_number', phone)
                    .eq('pin', pin)
                    .eq('is_active', true)
                    .single();

                if (error || !data) {
                    errorDiv.classList.add('show');
                    errorDiv.innerHTML = `❌ Invalid phone or PIN (E006)<br><span class="error-code">Error Code: E006</span>`;
                    button.disabled = false;
                    button.classList.remove('loading');
                    button.setAttribute('aria-busy', 'false');
                    button.textContent = 'Sign In';
                    return;
                }

                // Save session info
                const userData = {
                    id: data.id,
                    phone: data.phone_number,
                    name: data.full_name,
                    role: data.role
                };
                localStorage.setItem('dreamHarbourUser', JSON.stringify(userData));
                localStorage.setItem('userSession', JSON.stringify(userData));

                successDiv.classList.add('show');
                successDiv.textContent = '✓ Login successful! Redirecting...';

                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                return; // prevents further code from running
            } catch (error) {
                errorDiv.classList.add('show');
                errorDiv.innerHTML = `❌ Connection error (E007)<br><span class="error-code">Error Code: E007</span>`;
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
                button.setAttribute('aria-busy', 'false');
                button.textContent = 'Sign In';
            }
        }
        // ...Include phone validation, nextStep, backStep, etc., here as per your original
    </script>
</body>
</html>
