<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamHarbour - Invoice Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-info strong {
            display: block;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            font-weight: 600;
        }

        .nav-link:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .content {
            padding: 30px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 64, 175, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #333;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .search-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 10px rgba(30, 64, 175, 0.2);
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            font-size: 13px;
            text-transform: uppercase;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #666;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-draft {
            background: #f3e8ff;
            color: #7e22ce;
        }

        .status-pending {
            background: #fef3c7;
            color: #b45309;
        }

        .status-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            font-size: 22px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 20px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
        }

        .form-error {
            font-size: 12px;
            color: #ef4444;
            min-height: 18px;
        }

        .customer-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .customer-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .line-items {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .line-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .line-item input,
        .line-item select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 13px;
        }

        .line-item-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .line-item-remove:hover {
            background: #dc2626;
        }

        .add-line-item {
            background: #1e40af;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }

        .add-line-item:hover {
            background: #1e3a8a;
        }

        .invoice-summary {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: bold;
            color: #1e40af;
            border-top: 2px solid #bfdbfe;
            padding-top: 10px;
            margin-top: 10px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .success-message {
            padding: 12px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid #10b981;
        }

        .success-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .error-message {
            padding: 12px;
            background: #fee2e2;
            color: #991b1b;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid #ef4444;
        }

        .error-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e40af;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .invoice-template {
            background: white;
            padding: 40px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 20px;
        }

        .invoice-title {
            font-size: 28px;
            font-weight: bold;
            color: #1e40af;
        }

        .invoice-meta {
            text-align: right;
            font-size: 14px;
        }

        .invoice-meta div {
            margin-bottom: 5px;
        }

        .invoice-parties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .party-block h4 {
            color: #1e40af;
            font-size: 13px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .party-block p {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        .invoice-items {
            margin-bottom: 20px;
        }

        .invoice-items table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-items th {
            background: #1e40af;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
        }

        .invoice-items td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .invoice-totals {
            text-align: right;
            margin-bottom: 20px;
        }

        .total-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
            font-size: 14px;
            gap: 50px;
        }

        .total-row.grand {
            font-size: 18px;
            font-weight: bold;
            color: #1e40af;
            padding-top: 10px;
            border-top: 2px solid #1e40af;
        }

        .terms {
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media print {
            body, .modal, .header, .search-filter, .page-header {
                display: none;
            }
            .invoice-template {
                padding: 0;
                border: none;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                flex-direction: column;
                width: 100%;
            }

            .nav-link {
                width: 100%;
                text-align: center;
            }

            .content {
                padding: 20px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-title {
                font-size: 22px;
            }

            .search-filter {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .table-container {
                font-size: 12px;
            }

            table th, table td {
                padding: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .line-item {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 95%;
            }

            .invoice-parties {
                grid-template-columns: 1fr;
            }

            .invoice-header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">üè¢ DreamHarbour</div>
                <div class="user-info">
                    <strong id="userName">Invoices</strong>
                    <span>Invoice Management</span>
                </div>
            </div>
            <div class="header-right">
                <a href="dashboard.html" class="nav-link">‚Üê Back to Dashboard</a>
                <button class="nav-link" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div class="content">
            <div class="page-header">
                <h1 class="page-title">üìÑ Invoice Management</h1>
                <button class="btn btn-primary" onclick="openCreateInvoiceModal()">‚ûï Create New Invoice</button>
            </div>

            <!-- SEARCH & FILTER -->
            <div class="search-filter">
                <input type="text" id="searchInvoice" class="search-box" placeholder="üîç Search invoice number or customer..." onkeyup="filterInvoices()">
                <select id="statusFilter" class="filter-select" onchange="filterInvoices()">
                    <option value="">All Status</option>
                    <option value="draft">Draft</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                </select>
            </div>

            <!-- INVOICES TABLE -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>GST</th>
                            <th>Total</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CREATE INVOICE MODAL -->
    <div class="modal" id="createInvoiceModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCreateInvoiceModal()">&times;</button>
            <h2 class="modal-header">üìù Create New Invoice</h2>

            <form id="invoiceForm" onsubmit="saveInvoice(event)" novalidate>
                <!-- Customer Lookup -->
                <div class="form-group" style="position: relative;">
                    <label>Select Customer (or enter new)</label>
                    <input type="text" id="customerSearch" placeholder="Search by phone or name..." onkeyup="searchCustomers()" autocomplete="off">
                    <div class="customer-suggestions" id="customerSuggestions"></div>
                    <div class="form-error" id="customerSearchError"></div>
                </div>

                <!-- Customer Info -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name *</label>
                        <input type="text" id="customerName" placeholder="Enter customer name" required>
                        <div class="form-error" id="customerNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone *</label>
                        <input type="tel" id="customerPhone" placeholder="10-digit phone" maxlength="10" required>
                        <div class="form-error" id="customerPhoneError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="customerEmail">Email</label>
                        <input type="email" id="customerEmail" placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Address</label>
                        <input type="text" id="customerAddress" placeholder="Customer address">
                    </div>
                </div>

                <!-- Line Items with Service Selection -->
                <div class="line-items">
                    <h3 style="margin-bottom: 15px; color: #333;">üìã Services/Items</h3>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px; padding: 10px; background: #f0f9ff; border-radius: 5px;">
                        Service | Qty | HSN/SAC | Rate | GST% | Amount
                    </div>
                    <div id="lineItemsContainer"></div>
                    <button type="button" class="add-line-item" onclick="addLineItem()">+ Add Item</button>
                </div>

                <!-- Invoice Summary -->
                <div class="invoice-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">‚Çπ0</span>
                    </div>
                    <div class="summary-row">
                        <span>Total GST:</span>
                        <span id="gstAmount">‚Çπ0</span>
                    </div>
                    <div class="summary-total">
                        <span>Total:</span>
                        <span id="totalAmount">‚Çπ0</span>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label for="invoiceNotes">Notes (Optional)</label>
                    <textarea id="invoiceNotes" placeholder="Add payment terms, notes, etc." rows="3"></textarea>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="saveInvoiceDraft(event)">üíæ Save as Draft</button>
                    <button type="submit" class="btn btn-primary">‚úì Create Invoice</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateInvoiceModal()">Cancel</button>
                </div>

                <div class="success-message" id="invoiceSuccessMsg"></div>
                <div class="error-message" id="invoiceErrorMsg"></div>
            </form>
        </div>
    </div>

    <!-- VIEW INVOICE MODAL -->
    <div class="modal" id="viewInvoiceModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeViewInvoiceModal()">&times;</button>
            
            <div id="invoiceDetailsContent"></div>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print</button>
                <button class="btn btn-primary" onclick="downloadInvoicePDF()">üì• Download PDF</button>
                <button class="btn btn-secondary" id="markPaidBtn" onclick="markInvoiceAsPaid()">‚úì Mark as Paid</button>
                <button class="btn btn-secondary" onclick="closeViewInvoiceModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://lqrewteclbexiknvhenk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcmV3dGVjbGJleGlrbnZoZW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjQ2MDMsImV4cCI6MjA3NzA0MDYwM30.YLKmzuy3tfa9S09fzk4lYphBcl6a1jkeur3hUBaAHO8';

        let supabase = null;
        let currentUser = null;
        let allInvoices = [];
        let allServices = [];
        let allCustomers = [];
        let currentViewingInvoice = null;
        let lineItemsData = [];

        async function initializeInvoices() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const userSession = JSON.parse(localStorage.getItem('userSession'));
                
                if (!userSession) {
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = userSession;
                document.getElementById('userName').textContent = `Welcome, ${currentUser.name || 'User'}!`;

                await loadServices();
                await loadCustomers();
                await loadInvoices();

            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadServices() {
            try {
                const { data, error } = await supabase
                    .from('services')
                    .select('*')
                    .eq('is_active', true);

                if (error) throw error;
                allServices = data || [];
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        async function loadCustomers() {
            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                allCustomers = data || [];
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function loadInvoices() {
            try {
                const { data, error } = await supabase
                    .from('invoices')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                allInvoices = data || [];
                displayInvoices(allInvoices);
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }

        function displayInvoices(invoices) {
            const tbody = document.getElementById('invoicesTableBody');
            
            if (invoices.length === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-text">No invoices yet. Click "Create New Invoice" to get started.</div>
                        </div>
                    </td>
                </tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const subtotal = inv.subtotal_amount || 0;
                const gst = inv.gst_amount || 0;
                const total = subtotal + gst;
                const date = new Date(inv.created_at).toLocaleDateString('en-IN');

                return `
                    <tr>
                        <td><strong>${inv.invoice_number || 'N/A'}</strong></td>
                        <td>${inv.customer_name || 'Unknown'}</td>
                        <td>‚Çπ${fmt(subtotal)}</td>
                        <td>‚Çπ${fmt(gst)}</td>
                        <td><strong>‚Çπ${fmt(total)}</strong></td>
                        <td>${date}</td>
                        <td><span class="status-badge status-${inv.status || 'draft'}">${(inv.status || 'draft').toUpperCase()}</span></td>
                        <td>
                            <button class="btn btn-small" onclick="viewInvoice(${inv.id})" style="background: #3b82f6; color: white;">üëÅÔ∏è</button>
                            <button class="btn btn-small" onclick="deleteInvoice(${inv.id})" style="background: #ef4444; color: white;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoices() {
            const search = document.getElementById('searchInvoice').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            const filtered = allInvoices.filter(inv => {
                const matchesSearch = !search || 
                    (inv.invoice_number && inv.invoice_number.toLowerCase().includes(search)) ||
                    (inv.customer_name && inv.customer_name.toLowerCase().includes(search));
                
                const matchesStatus = !status || (inv.status || 'draft') === status;

                return matchesSearch && matchesStatus;
            });

            displayInvoices(filtered);
        }

        function searchCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const suggestionsDiv = document.getElementById('customerSuggestions');

            if (!search) {
                suggestionsDiv.classList.remove('show');
                return;
            }

            const filtered = allCustomers.filter(cust => 
                cust.phone.includes(search) || cust.name.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                suggestionsDiv.classList.remove('show');
                return;
            }

            suggestionsDiv.innerHTML = filtered.map(cust => `
                <div class="suggestion-item" onclick="selectCustomer('${cust.name}', '${cust.phone}', '${cust.email || ''}', '${cust.address || ''}')">
                    <strong>${cust.name}</strong> | ${cust.phone}
                </div>
            `).join('');

            suggestionsDiv.classList.add('show');
        }

        function selectCustomer(name, phone, email, address) {
            document.getElementById('customerName').value = name;
            document.getElementById('customerPhone').value = phone;
            document.getElementById('customerEmail').value = email;
            document.getElementById('customerAddress').value = address;
            document.getElementById('customerSearch').value = '';
            document.getElementById('customerSuggestions').classList.remove('show');
        }

        function openCreateInvoiceModal() {
            document.getElementById('invoiceForm').reset();
            lineItemsData = [];
            addLineItem();
            document.getElementById('createInvoiceModal').classList.add('show');
            document.getElementById('customerSearch').focus();
        }

        function closeCreateInvoiceModal() {
            document.getElementById('createInvoiceModal').classList.remove('show');
            document.getElementById('invoiceForm').reset();
            lineItemsData = [];
        }

        function addLineItem() {
            const itemId = lineItemsData.length;
            lineItemsData.push({ service: '', quantity: 1, rate: 0, hsn_sac: '', gst: 18 });

            const container = document.getElementById('lineItemsContainer');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'line-item';
            itemDiv.id = `lineItem-${itemId}`;
            
            let serviceOptions = '<option value="">Select Service</option>';
            allServices.forEach(svc => {
                serviceOptions += `<option value="${svc.id}" data-hsn="${svc.hsn_sac || ''}" data-gst="${svc.gst_percentage || 18}">${svc.service_name}</option>`;
            });

            itemDiv.innerHTML = `
                <select onchange="updateLineItem(${itemId}, 'service', this.value)">
                    ${serviceOptions}
                </select>
                <input type="number" placeholder="Qty" value="1" min="1" onchange="updateLineItem(${itemId}, 'quantity', this.value)">
                <input type="text" placeholder="HSN/SAC" readonly style="background: #f8f9fa;">
                <input type="number" placeholder="Rate" value="0" min="0" step="0.01" onchange="updateLineItem(${itemId}, 'rate', this.value)">
                <input type="number" placeholder="GST%" value="18" min="0" max="100" onchange="updateLineItem(${itemId}, 'gst', this.value)">
                <input type="text" readonly value="‚Çπ0" style="background: #f8f9fa; font-weight: bold; text-align: right;">
                <button type="button" class="line-item-remove" onclick="removeLineItem(${itemId})">Remove</button>
            `;
            container.appendChild(itemDiv);
            calculateInvoiceTotals();
        }

        function updateLineItem(itemId, field, value) {
            if (field === 'service') {
                const selectedService = allServices.find(s => s.id == value);
                if (selectedService) {
                    lineItemsData[itemId].service = selectedService.service_name;
                    lineItemsData[itemId].hsn_sac = selectedService.hsn_sac || '';
                    lineItemsData[itemId].gst = selectedService.gst_percentage || 18;
                    lineItemsData[itemId].rate = selectedService.price || 0;
                }
            } else if (field === 'quantity') {
                lineItemsData[itemId].quantity = parseInt(value) || 0;
            } else if (field === 'rate') {
                lineItemsData[itemId].rate = parseFloat(value) || 0;
            } else if (field === 'gst') {
                lineItemsData[itemId].gst = parseFloat(value) || 18;
            }
            calculateInvoiceTotals();
            updateLineItemDisplay(itemId);
        }

        function updateLineItemDisplay(itemId) {
            const amount = lineItemsData[itemId].quantity * lineItemsData[itemId].rate;
            const itemDiv = document.getElementById(`lineItem-${itemId}`);
            if (itemDiv) {
                const inputs = itemDiv.querySelectorAll('input, select');
                inputs[2].value = lineItemsData[itemId].hsn_sac;
                inputs[4].value = lineItemsData[itemId].gst || 18;
                inputs[5].value = '‚Çπ' + fmt(amount);
            }
        }

        function removeLineItem(itemId) {
            const itemDiv = document.getElementById(`lineItem-${itemId}`);
            if (itemDiv) {
                itemDiv.remove();
            }
            lineItemsData.splice(itemId, 1);
            calculateInvoiceTotals();
        }

        function calculateInvoiceTotals() {
            let subtotal = 0;
            let totalGST = 0;

            lineItemsData.forEach(item => {
                const amount = item.quantity * item.rate;
                subtotal += amount;
                const gstAmount = amount * (item.gst || 18) / 100;
                totalGST += gstAmount;
            });

            const total = subtotal + totalGST;

            document.getElementById('subtotal').textContent = '‚Çπ' + fmt(subtotal);
            document.getElementById('gstAmount').textContent = '‚Çπ' + fmt(totalGST);
            document.getElementById('totalAmount').textContent = '‚Çπ' + fmt(total);
        }

        async function saveInvoice(event) {
            event.preventDefault();

            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();

            if (!customerName) {
                showError('customerNameError', 'Customer name is required');
                return;
            }
            if (!customerPhone || customerPhone.length !== 10) {
                showError('customerPhoneError', 'Valid 10-digit phone required');
                return;
            }
            if (lineItemsData.length === 0 || lineItemsData.every(item => !item.service)) {
                showErrorMsg('invoiceErrorMsg', 'Add at least one service/item');
                return;
            }

            try {
                let subtotal = 0;
                let totalGST = 0;

                lineItemsData.forEach(item => {
                    const amount = item.quantity * item.rate;
                    subtotal += amount;
                    totalGST += amount * (item.gst || 18) / 100;
                });

                const invoiceNumber = 'INV-' + new Date().getFullYear() + '-' + String(1000 + allInvoices.length + 1).slice(1);

                const { data, error } = await supabase
                    .from('invoices')
                    .insert({
                        invoice_number: invoiceNumber,
                        customer_name: customerName,
                        customer_phone: customerPhone,
                        customer_email: document.getElementById('customerEmail').value,
                        customer_address: document.getElementById('customerAddress').value,
                        line_items: JSON.stringify(lineItemsData),
                        subtotal_amount: subtotal,
                        gst_amount: totalGST,
                        total_amount: subtotal + totalGST,
                        status: 'pending',
                        notes: document.getElementById('invoiceNotes').value,
                        created_by: currentUser.name,
                        created_at: new Date()
                    });

                if (error) throw error;

                showSuccess('invoiceSuccessMsg', '‚úì Invoice created successfully!');
                setTimeout(() => {
                    closeCreateInvoiceModal();
                    loadInvoices();
                }, 1500);

            } catch (error) {
                showErrorMsg('invoiceErrorMsg', 'Failed to create invoice: ' + error.message);
            }
        }

        async function saveInvoiceDraft(event) {
            event.preventDefault();

            const customerName = document.getElementById('customerName').value.trim();
            
            if (!customerName) {
                showError('customerNameError', 'Customer name is required');
                return;
            }

            try {
                let subtotal = 0;
                let totalGST = 0;

                lineItemsData.forEach(item => {
                    const amount = item.quantity * item.rate;
                    subtotal += amount;
                    totalGST += amount * (item.gst || 18) / 100;
                });

                const invoiceNumber = 'DRAFT-' + Date.now();

                const { data, error } = await supabase
                    .from('invoices')
                    .insert({
                        invoice_number: invoiceNumber,
                        customer_name: customerName,
                        customer_phone: document.getElementById('customerPhone').value || 'N/A',
                        customer_email: document.getElementById('customerEmail').value,
                        customer_address: document.getElementById('customerAddress').value,
                        line_items: JSON.stringify(lineItemsData),
                        subtotal_amount: subtotal,
                        gst_amount: totalGST,
                        total_amount: subtotal + totalGST,
                        status: 'draft',
                        notes: document.getElementById('invoiceNotes').value,
                        created_by: currentUser.name,
                        created_at: new Date()
                    });

                if (error) throw error;

                showSuccess('invoiceSuccessMsg', '‚úì Invoice saved as draft!');
                setTimeout(() => {
                    closeCreateInvoiceModal();
                    loadInvoices();
                }, 1500);

            } catch (error) {
                showErrorMsg('invoiceErrorMsg', 'Failed to save draft: ' + error.message);
            }
        }

        async function viewInvoice(invoiceId) {
            try {
                const { data, error } = await supabase
                    .from('invoices')
                    .select('*')
                    .eq('id', invoiceId)
                    .single();

                if (error) throw error;

                currentViewingInvoice = data;
                const lineItems = JSON.parse(data.line_items || '[]');
                
                // Build invoice template
                let itemsHTML = `<table class="invoice-items"><thead><tr><th>Service/Item</th><th>HSN/SAC</th><th>Qty</th><th>Rate</th><th>GST%</th><th>Amount</th></tr></thead><tbody>`;
                
                let subtotal = 0;
                let totalGST = 0;

                lineItems.forEach(item => {
                    const amount = item.quantity * item.rate;
                    const gstAmount = amount * (item.gst || 18) / 100;
                    subtotal += amount;
                    totalGST += gstAmount;

                    itemsHTML += `<tr>
                        <td>${item.service}</td>
                        <td>${item.hsn_sac || '-'}</td>
                        <td>${item.quantity}</td>
                        <td>‚Çπ${fmt(item.rate)}</td>
                        <td>${item.gst || 18}%</td>
                        <td>‚Çπ${fmt(amount + gstAmount)}</td>
                    </tr>`;
                });

                itemsHTML += '</tbody></table>';

                const content = `
                    <div class="invoice-template">
                        <div class="invoice-header">
                            <div class="invoice-title">INVOICE</div>
                            <div class="invoice-meta">
                                <div><strong>${data.invoice_number}</strong></div>
                                <div>${new Date(data.created_at).toLocaleDateString('en-IN')}</div>
                                <div><strong>Status:</strong> ${(data.status || 'draft').toUpperCase()}</div>
                            </div>
                        </div>

                        <div class="invoice-parties">
                            <div class="party-block">
                                <h4>Bill From</h4>
                                <p>DreamHarbour Global<br>Invoice Management System</p>
                            </div>
                            <div class="party-block">
                                <h4>Bill To</h4>
                                <p>${data.customer_name}<br>Phone: ${data.customer_phone}<br>Email: ${data.customer_email || 'N/A'}<br>${data.customer_address || ''}</p>
                            </div>
                        </div>

                        <div class="invoice-items">
                            ${itemsHTML}
                        </div>

                        <div class="invoice-totals">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span>‚Çπ${fmt(subtotal)}</span>
                            </div>
                            <div class="total-row">
                                <span>Total GST:</span>
                                <span>‚Çπ${fmt(totalGST)}</span>
                            </div>
                            <div class="total-row grand">
                                <span>TOTAL:</span>
                                <span>‚Çπ${fmt(subtotal + totalGST)}</span>
                            </div>
                        </div>

                        ${data.notes ? `<div class="terms"><strong>Notes:</strong><br>${data.notes}</div>` : ''}
                    </div>
                `;

                document.getElementById('invoiceDetailsContent').innerHTML = content;
                
                // Show/hide mark as paid button
                const markPaidBtn = document.getElementById('markPaidBtn');
                if (data.status === 'paid') {
                    markPaidBtn.style.display = 'none';
                } else {
                    markPaidBtn.style.display = 'block';
                }

                document.getElementById('viewInvoiceModal').classList.add('show');

            } catch (error) {
                console.error('Error viewing invoice:', error);
            }
        }

        function closeViewInvoiceModal() {
            document.getElementById('viewInvoiceModal').classList.remove('show');
        }

        function printInvoice() {
            window.print();
        }

        function downloadInvoicePDF() {
            if (!currentViewingInvoice) return;

            const element = document.querySelector('.invoice-template');
            const opt = {
                margin: 10,
                filename: currentViewingInvoice.invoice_number + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(element).save();
        }

        async function markInvoiceAsPaid() {
            if (!currentViewingInvoice) return;

            try {
                const { error } = await supabase
                    .from('invoices')
                    .update({ status: 'paid', updated_at: new Date() })
                    .eq('id', currentViewingInvoice.id);

                if (error) throw error;

                alert('‚úì Invoice marked as paid!');
                closeViewInvoiceModal();
                loadInvoices();

            } catch (error) {
                alert('Failed to update invoice');
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('Are you sure you want to delete this invoice?')) return;

            try {
                const { error } = await supabase
                    .from('invoices')
                    .delete()
                    .eq('id', invoiceId);

                if (error) throw error;

                loadInvoices();
            } catch (error) {
                console.error('Error deleting invoice:', error);
            }
        }

        function fmt(n) {
            return new Intl.NumberFormat('en-IN').format(Math.round(n));
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
            }
        }

        function showSuccess(elementId, message) {
            const successDiv = document.getElementById(elementId);
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.classList.add('show');
            }
        }

        function showErrorMsg(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 5000);
            }
        }

        function logout() {
            if (confirm('Logout?')) {
                localStorage.removeItem('userSession');
                window.location.href = 'index.html';
            }
        }

        window.addEventListener('load', initializeInvoices);
    </script>
</body>
</html>