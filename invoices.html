<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamHarbour - Invoices</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); min-height: 100vh; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 22px; font-weight: bold; }
        .nav-link { color: white; padding: 8px 16px; background: rgba(0,0,0,0.2); border-radius: 5px; cursor: pointer; border: none; font-weight: 600; margin-left: 10px; }
        .content { padding: 25px; }
        .form-section { background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #374151; }
        .form-group input, .form-group select { padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #1e40af; box-shadow: 0 0 0 3px rgba(30,64,175,0.1); }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; background: #1e40af; color: white; margin-right: 10px; }
        .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
        .btn-danger { background: #ef4444; }
        .btn-success { background: #10b981; }
        .btn:hover { opacity: 0.9; }
        .table-wrapper { overflow-x: auto; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        table th { background: #f5f5f5; padding: 10px 8px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        table td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        table tr:hover { background: #f9f9f9; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-draft { background: #fef08a; color: #92400e; }
        .badge-sent { background: #dbeafe; color: #1e40af; }
        .badge-paid { background: #d1fae5; color: #065f46; }
        .action-btn { padding: 6px 10px; margin: 0 2px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .action-btn.edit { background: #3b82f6; color: white; }
        .action-btn.pdf { background: #ef4444; color: white; }
        .action-btn.delete { background: #9ca3af; color: white; }
        .line-items { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px; }
        .line-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 80px; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid #e5e7eb; margin-bottom: 10px; }
        .line-item input { padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 12px; }
        .totals { background: #f0f9ff; padding: 15px; border-radius: 8px; border: 2px solid #bfdbfe; text-align: right; }
        .total-row { display: flex; justify-content: flex-end; gap: 30px; margin-bottom: 10px; }
        .total-label { font-weight: 600; width: 100px; }
        .total-value { width: 100px; text-align: right; }
        .success-msg { padding: 10px 12px; background: #d1fae5; color: #065f46; border-radius: 6px; margin-bottom: 12px; font-size: 12px; display: none; }
        .success-msg.show { display: block; }
        .empty-state { text-align: center; padding: 30px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üìÑ DreamHarbour - Invoices</div>
            <div><a href="dashboard.html"><button class="nav-link">‚Üê Dashboard</button></a><a href="settings.html"><button class="nav-link">‚öôÔ∏è Settings</button></a><button class="nav-link" onclick="logout()">üö™ Logout</button></div>
        </div>

        <div class="content">
            <div class="success-msg" id="successMsg"></div>

            <!-- CREATE/EDIT INVOICE FORM -->
            <div class="form-section" id="formSection" style="display:none">
                <h3 style="color: #1e40af; margin-bottom: 15px;">üìù Create Invoice</h3>
                <form onsubmit="saveInvoice(event)" id="invoiceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer *</label>
                            <select id="customerId" required onchange="loadCustomerInfo()">
                                <option value="">--Select--</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Date *</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="customerName" readonly>
                        </div>
                        <div class="form-group">
                            <label>Mobile</label>
                            <input type="text" id="customerMobile" readonly>
                        </div>
                    </div>

                    <h4 style="color: #1e40af; margin: 20px 0 15px 0;">Line Items</h4>
                    <div class="line-items" id="lineItemsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addLineItem()">‚ûï Add Item</button>

                    <div class="totals" style="margin-top: 20px;">
                        <div class="total-row">
                            <span class="total-label">Subtotal:</span>
                            <span class="total-value" id="subtotal">‚Çπ0</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">GST (18%):</span>
                            <span class="total-value" id="gstAmount">‚Çπ0</span>
                        </div>
                        <div class="total-row" style="font-size: 16px; font-weight: 700;">
                            <span class="total-label">Total:</span>
                            <span class="total-value" id="totalAmount">‚Çπ0</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-success">üíæ Save Invoice</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelForm()">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- INVOICES LIST -->
            <div id="listSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #1e40af;">üìä Invoices</h3>
                    <button class="btn" onclick="showForm()">‚ûï New Invoice</button>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPA_URL = 'https://lqrewteclbexiknvhenk.supabase.co';
        const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcmV3dGVjbGJleGlrbnZoZW5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjQ2MDMsImV4cCI6MjA3NzA0MDYwM30.YLKmzuy3tfa9S09fzk4lYphBcl6a1jkeur3hUBaAHO8';
        let db = null;
        let invoices = [];
        let customers = [];
        let services = [];
        let lineItemCount = 0;

        async function init() {
            db = window.supabase.createClient(SUPA_URL, SUPA_KEY);
            const user = JSON.parse(localStorage.getItem('userSession'));
            if (!user) { window.location.href = 'index.html'; return; }
            
            document.getElementById('invoiceDate').valueAsDate = new Date();
            await loadData();
        }

        async function loadData() {
            try {
                const [inv, cust, svc] = await Promise.all([
                    db.from('invoices').select('*'),
                    db.from('customers').select('*'),
                    db.from('service_types').select('*')
                ]);
                
                invoices = inv.data || [];
                customers = cust.data || [];
                services = svc.data || [];
                
                populateCustomerSelect();
                displayInvoices();
            } catch (e) { console.error(e); }
        }

        function populateCustomerSelect() {
            const select = document.getElementById('customerId');
            select.innerHTML = '<option value="">--Select Customer--</option>' +
                customers.map(c => `<option value="${c.id}">${c.customer_name} (${c.mobile_no})</option>`).join('');
        }

        function loadCustomerInfo() {
            const custId = document.getElementById('customerId').value;
            const cust = customers.find(c => c.id === custId);
            if (cust) {
                document.getElementById('customerName').value = cust.customer_name;
                document.getElementById('customerMobile').value = cust.mobile_no;
            }
        }

        function addLineItem() {
            lineItemCount++;
            const container = document.getElementById('lineItemsContainer');
            const html = `
                <div class="line-item" id="item-${lineItemCount}">
                    <select onchange="updateLineItem(${lineItemCount})">
                        <option value="">--Select Service--</option>
                        ${services.map(s => `<option value="${s.id}" data-rate="${s.rate}" data-gst="${s.gst_percentage}">${s.service_name}</option>`).join('')}
                    </select>
                    <input type="number" placeholder="Qty" value="1" onchange="updateLineItem(${lineItemCount})" min="1">
                    <input type="number" placeholder="Rate" onchange="updateLineItem(${lineItemCount})" step="0.01" min="0">
                    <input type="number" placeholder="Amount" readonly step="0.01">
                    <button type="button" class="btn btn-secondary" style="padding: 5px 8px;" onclick="removeLineItem(${lineItemCount})">√ó</button>
                </div>
            `;
            container.innerHTML += html;
        }

        function updateLineItem(id) {
            const item = document.getElementById(`item-${id}`);
            const inputs = item.querySelectorAll('input, select');
            const qty = parseFloat(inputs[1].value) || 0;
            const rate = parseFloat(inputs[2].value) || 0;
            const amount = qty * rate;
            inputs[3].value = amount.toFixed(2);
            calculateTotals();
        }

        function removeLineItem(id) {
            document.getElementById(`item-${id}`).remove();
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.line-item input[placeholder="Amount"]').forEach(el => {
                subtotal += parseFloat(el.value) || 0;
            });
            const gst = subtotal * 0.18;
            const total = subtotal + gst;
            
            document.getElementById('subtotal').textContent = '‚Çπ' + subtotal.toFixed(2);
            document.getElementById('gstAmount').textContent = '‚Çπ' + gst.toFixed(2);
            document.getElementById('totalAmount').textContent = '‚Çπ' + total.toFixed(2);
        }

        async function saveInvoice(e) {
            e.preventDefault();
            const custId = document.getElementById('customerId').value;
            const date = document.getElementById('invoiceDate').value;
            const total = parseFloat(document.getElementById('totalAmount').textContent.replace('‚Çπ', ''));
            
            try {
                const { data: inv, error } = await db.from('invoices').insert([{
                    customer_id: custId,
                    invoice_date: date,
                    total_amount: total,
                    status: 'draft'
                }]);
                
                if (error) throw error;
                showMessage('Invoice saved!');
                cancelForm();
                await loadData();
            } catch (e) { console.error(e); }
        }

        function displayInvoices() {
            const table = document.getElementById('invoicesTable');
            if (invoices.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="empty-state">No invoices</td></tr>';
                return;
            }
            
            table.innerHTML = invoices.map((inv, idx) => {
                const cust = customers.find(c => c.id === inv.customer_id);
                return `<tr>
                    <td>#${idx + 1001}</td>
                    <td>${cust?.customer_name || '-'}</td>
                    <td>${new Date(inv.invoice_date).toLocaleDateString('en-IN')}</td>
                    <td>‚Çπ${inv.total_amount.toFixed(2)}</td>
                    <td><span class="badge badge-${inv.status || 'draft'}">${inv.status || 'Draft'}</span></td>
                    <td>
                        <button class="action-btn pdf" onclick="generatePDF(${idx})">üìÑ PDF</button>
                        <button class="action-btn delete" onclick="deleteInvoice('${inv.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function generatePDF(idx) {
            const inv = invoices[idx];
            const cust = customers.find(c => c.id === inv.customer_id);
            
            const element = document.createElement('div');
            element.innerHTML = `
                <div style="padding: 20px; font-family: Arial;">
                    <h1>INVOICE</h1>
                    <p><strong>Invoice #:</strong> #${idx + 1001}</p>
                    <p><strong>Date:</strong> ${new Date(inv.invoice_date).toLocaleDateString('en-IN')}</p>
                    <p><strong>Customer:</strong> ${cust?.customer_name}</p>
                    <p><strong>Mobile:</strong> ${cust?.mobile_no}</p>
                    <p style="margin-top: 20px;"><strong>Total Amount:</strong> ‚Çπ${inv.total_amount.toFixed(2)}</p>
                </div>
            `;
            
            const opt = { margin: 10, filename: `Invoice_${idx + 1001}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' } };
            html2pdf().set(opt).from(element).save();
        }

        async function deleteInvoice(id) {
            if (!confirm('Delete invoice?')) return;
            await db.from('invoices').delete().eq('id', id);
            await loadData();
        }

        function showForm() {
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('listSection').style.display = 'none';
            lineItemCount = 0;
            document.getElementById('lineItemsContainer').innerHTML = '';
            addLineItem();
        }

        function cancelForm() {
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('listSection').style.display = 'block';
            document.getElementById('invoiceForm').reset();
        }

        function showMessage(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = '‚úì ' + msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function logout() {
            if (confirm('Logout?')) {
                localStorage.removeItem('userSession');
                window.location.href = 'index.html';
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>