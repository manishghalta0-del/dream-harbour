<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoices</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .navbar { background-color: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; }
        .sidebar { background-color: #34495e; color: white; width: 200px; min-height: calc(100vh - 60px); position: fixed; left: 0; top: 60px; }
        .sidebar a { display: block; padding: 15px 20px; color: white; text-decoration: none; }
        .main-content { margin-left: 200px; padding: 20px; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal.show { display: block; }
        .modal-content { background-color: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 600px; border-radius: 5px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        button { background-color: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #2980b9; }
        input, select, textarea { width: 100%; padding: 8px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #2c3e50; color: white; }
        label { display: block; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìã Invoices</h1>
        <button onclick="logout()" style="background-color: #e74c3c;">Logout</button>
    </div>
    
    <div class="sidebar">
        <a href="dashboard.html">üìä Dashboard</a>
        <a href="invoices.html">üìã Invoices</a>
        <a href="settings.html">‚öôÔ∏è Settings</a>
    </div>
    
    <div class="main-content">
        <button onclick="openModal()">‚ûï Create New Invoice</button>
        
        <h2>Recent Invoices</h2>
        <table id="invoiceTable">
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="invoiceList">
                <tr><td colspan="5">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>üìã Create New Invoice</h2>
            
            <label>Customer Mobile (Database Lookup)</label>
            <input type="text" id="customerMobile" maxlength="10" onblur="lookupCustomer()">
            
            <label>Customer Name</label>
            <input type="text" id="customerName">
            
            <label>Email</label>
            <input type="email" id="customerEmail">
            
            <label>Address</label>
            <textarea id="customerAddress"></textarea>
            
            <label>GSTIN</label>
            <input type="text" id="customerGSTIN">
            
            <label>Select Service</label>
            <select id="serviceType" onchange="onServiceChange()">
                <option value="">-- Select Service --</option>
            </select>
            
            <label>Quantity</label>
            <input type="number" id="serviceQuantity" value="1" min="1">
            
            <label>Rate</label>
            <input type="number" id="serviceRate" step="0.01">
            
            <button onclick="addService()">+ Add Service</button>
            
            <h3>Added Services</h3>
            <table id="serviceTable">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Qty</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>GST</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="serviceItemsList"></tbody>
            </table>
            
            <h3>Totals</h3>
            <p>Subtotal: <strong id="subtotal">‚Çπ0</strong></p>
            <p>GST: <strong id="totalGST">‚Çπ0</strong></p>
            <p>Total: <strong id="grandTotal">‚Çπ0</strong></p>
            
            <label>Payment Status</label>
            <select id="paymentStatus">
                <option value="Pending">Pending</option>
                <option value="Paid">Paid</option>
            </select>
            
            <button onclick="submitInvoice()">‚úì Submit</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="common.js"></script>
    <script>
        let allServices = [];
        let selectedServices = [];
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!checkSession()) return;
            await loadServices();
            await loadInvoices();
        });
        
        async function loadServices() {
            try {
                const { data } = await supabase.from('service_types').select('*').eq('is_active', true);
                allServices = data || [];
                
                const select = document.getElementById('serviceType');
                select.innerHTML = '<option value="">-- Select Service --</option>';
                allServices.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = service.service_name;
                    option.dataset.rate = service.base_rate;
                    option.dataset.gst = service.gst_percentage;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }
        
        async function loadInvoices() {
            try {
                const { data } = await supabase.from('invoices').select('*').order('created_at', { ascending: false }).limit(10);
                const list = document.getElementById('invoiceList');
                list.innerHTML = (data || []).map(inv => `
                    <tr>
                        <td>${inv.invoice_number}</td>
                        <td>${formatDate(inv.invoice_date)}</td>
                        <td>${inv.customer_id}</td>
                        <td>${formatCurrency(inv.total_amount)}</td>
                        <td>${inv.payment_status}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }
        
        function openModal() {
            document.getElementById('invoiceModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('invoiceModal').classList.remove('show');
            selectedServices = [];
            document.getElementById('serviceItemsList').innerHTML = '';
        }
        
        async function lookupCustomer() {
            const mobile = document.getElementById('customerMobile').value;
            if (mobile.length === 10) {
                try {
                    const { data } = await supabase.from('customers').select('*').eq('mobile_no', mobile).single();
                    if (data) {
                        document.getElementById('customerName').value = data.full_name;
                        document.getElementById('customerEmail').value = data.email || '';
                        document.getElementById('customerGSTIN').value = data.gstin || '';
                        document.getElementById('customerAddress').value = data.address || '';
                        showAlert('Customer found!');
                    }
                } catch (error) {
                    console.log('New customer');
                }
            }
        }
        
        function onServiceChange() {
            const select = document.getElementById('serviceType');
            const option = select.options[select.selectedIndex];
            if (option.dataset.rate) {
                document.getElementById('serviceRate').value = option.dataset.rate;
            }
        }
        
        function addService() {
            const serviceId = document.getElementById('serviceType').value;
            const quantity = parseInt(document.getElementById('serviceQuantity').value) || 1;
            const rate = parseFloat(document.getElementById('serviceRate').value) || 0;
            
            if (!serviceId || quantity < 1 || rate <= 0) {
                showAlert('Please fill all fields correctly');
                return;
            }
            
            const service = allServices.find(s => s.id === serviceId);
            const amount = quantity * rate;
            const gst = (amount * (service.gst_percentage || 18)) / 100;
            
            selectedServices.push({
                id: serviceId,
                name: service.service_name,
                quantity,
                rate,
                amount,
                gst,
                gstPercent: service.gst_percentage || 18
            });
            
            displayServices();
        }
        
        function displayServices() {
            const list = document.getElementById('serviceItemsList');
            let subtotal = 0, totalGST = 0;
            
            list.innerHTML = selectedServices.map((srv, i) => {
                subtotal += srv.amount;
                totalGST += srv.gst;
                return `
                    <tr>
                        <td>${srv.name}</td>
                        <td>${srv.quantity}</td>
                        <td>${formatCurrency(srv.rate)}</td>
                        <td>${formatCurrency(srv.amount)}</td>
                        <td>${srv.gstPercent}% = ${formatCurrency(srv.gst)}</td>
                        <td>${formatCurrency(srv.amount + srv.gst)}</td>
                        <td><button onclick="selectedServices.splice(${i}, 1); displayServices();">Remove</button></td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('totalGST').textContent = formatCurrency(totalGST);
            document.getElementById('grandTotal').textContent = formatCurrency(subtotal + totalGST);
        }
        
        async function submitInvoice() {
            const phone = document.getElementById('customerMobile').value;
            const name = document.getElementById('customerName').value;
            
            if (!phone || !name || selectedServices.length === 0) {
                showAlert('Please fill customer details and add services');
                return;
            }
            
            try {
                let customerId;
                let customer = (await supabase.from('customers').select('*').eq('mobile_no', phone).single()).data;
                
                if (!customer) {
                    const { data } = await supabase.from('customers').insert([{
                        mobile_no: phone,
                        full_name: name,
                        email: document.getElementById('customerEmail').value,
                        gstin: document.getElementById('customerGSTIN').value,
                        address: document.getElementById('customerAddress').value
                    }]).select();
                    customerId = data[0].id;
                } else {
                    customerId = customer.id;
                }
                
                let subtotal = 0, totalGST = 0;
                selectedServices.forEach(srv => {
                    subtotal += srv.amount;
                    totalGST += srv.gst;
                });
                
                const { data: inv } = await supabase.from('invoices').insert([{
                    invoice_number: 'INV-' + Date.now(),
                    customer_id: customerId,
                    created_by: currentUser.id,
                    invoice_date: new Date().toISOString(),
                    subtotal: subtotal,
                    total_gst: totalGST,
                    total_amount: subtotal + totalGST,
                    payment_status: document.getElementById('paymentStatus').value
                }]).select();
                
                const invoiceId = inv[0].id;
                
                await supabase.from('invoice_items').insert(selectedServices.map(srv => ({
                    invoice_id: invoiceId,
                    description: srv.name,
                    quantity: srv.quantity,
                    rate: srv.rate,
                    amount: srv.amount,
                    gst_percentage: srv.gstPercent,
                    gst_amount: srv.gst
                })));
                
                showAlert('Invoice created successfully!');
                closeModal();
                loadInvoices();
                
            } catch (error) {
                showAlert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>